<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>加拿大28 分析工具 2代 - PC28 | Q群：1077134386 飞机：@laomao12315</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Microsoft YaHei', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            color: #333;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
            background: white;
            border-radius: 16px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 24px;
            font-weight: 600;
            margin-bottom: 5px;
        }

        /* 倒计时面板 */
        .countdown-panel {
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            padding: 30px;
            text-align: center;
            border-bottom: 3px solid #667eea;
        }

        .big-timer {
            font-size: 72px;
            font-weight: bold;
            color: #d00000;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.2);
            margin: 20px 0;
            padding: 20px;
            background: white;
            border-radius: 12px;
            border: 3px solid #d00000;
            display: inline-block;
            min-width: 200px;
            transition: transform 0.3s;
        }

        .big-timer:hover {
            transform: scale(1.05);
        }

        .prev-summary {
            font-size: 16px;
            font-weight: bold;
            margin: 15px 0;
            color: #333;
        }

        .number-badge {
            display: inline-block;
            min-width: 28px;
            padding: 4px 8px;
            margin: 0 3px;
            background: #0078d4;
            color: white;
            border-radius: 6px;
            text-align: center;
            font-weight: bold;
        }

        .current-issue {
            font-size: 15px;
            font-weight: bold;
            margin: 10px 0;
            color: #333;
        }

        .predictions-row {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin: 20px 0;
            flex-wrap: wrap;
        }

        .prediction-box {
            padding: 12px 20px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: bold;
            min-width: 220px;
            text-align: center;
            border: 2px solid;
            transition: all 0.3s;
            cursor: pointer;
        }

        .prediction-box:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }

        .prediction-laomao {
            background: #fff5f5;
            border-color: #b21824;
            color: #b21824;
        }

        .prediction-kill2 {
            background: #fff8f0;
            border-color: #d35400;
            color: #d35400;
        }

        .prediction-ai {
            background: #f0f5ff;
            border-color: #335397;
            color: #335397;
        }

        .open-time {
            font-size: 13px;
            color: #666;
            font-weight: bold;
            margin-top: 10px;
        }

        /* 顶部信息区 */
        .info-bar {
            background: #f8f9fa;
            padding: 15px 30px;
            display: flex;
            align-items: center;
            gap: 20px;
            flex-wrap: wrap;
            border-bottom: 2px solid #e0e0e0;
        }

        .info-item {
            font-size: 14px;
            font-weight: bold;
            color: #333;
        }

        .btn-refresh {
            background: #0078d4;
            color: white;
            border: none;
            padding: 8px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: bold;
            font-size: 14px;
            transition: all 0.3s;
            margin-left: auto;
        }

        .btn-refresh:hover {
            background: #005a9e;
            transform: scale(1.05);
        }

        .btn-refresh:active {
            transform: scale(0.95);
        }

        /* 主要内容区 */
        .main-content {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 20px;
            padding: 20px 30px;
        }

        @media (max-width: 1400px) {
            .main-content {
                grid-template-columns: 1fr;
            }
        }

        .section {
            background: #f8f9fa;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            width: 100%;
            overflow: hidden; /* 防止内容溢出 */
        }

        .section-title {
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 15px;
            color: #333;
            border-bottom: 2px solid #667eea;
            padding-bottom: 8px;
        }

        .scroll-hint {
            font-size: 12px;
            color: #666;
            font-weight: normal;
            margin-left: 10px;
            display: inline-block;
        }

        @media (max-width: 768px) {
            .scroll-hint {
                display: block;
                margin-left: 0;
                margin-top: 5px;
                font-size: 11px;
            }
        }

        /* 表格样式 */
        .table-container {
            overflow-x: auto;
            overflow-y: auto;
            max-height: 600px;
            width: 100%;
            position: relative;
            -webkit-overflow-scrolling: touch; /* 移动端平滑滚动 */
            border: 1px solid #e0e0e0;
            border-radius: 8px;
        }

        table {
            width: 100%;
            min-width: 1200px; /* 设置最小宽度，确保在小屏幕上出现横向滚动条 */
            border-collapse: collapse;
            font-size: 12px;
            background: white;
            table-layout: auto; /* 自动调整列宽 */
        }

        /* 响应式表格列宽 */
        @media (max-width: 1600px) {
            table {
                min-width: 1100px;
            }
        }

        @media (max-width: 1400px) {
            table {
                min-width: 1000px;
            }
        }

        thead {
            position: sticky;
            top: 0;
            background: #667eea;
            color: white;
            z-index: 10;
        }

        th {
            padding: 12px 8px;
            text-align: center;
            font-weight: bold;
            border: 1px solid #ddd;
        }

        td {
            padding: 10px 8px;
            text-align: center;
            border: 1px solid #ddd;
            font-weight: bold;
        }

        tbody tr:nth-child(even) {
            background: #f5f5f5;
        }

        tbody tr:hover {
            background: #e3f2fd;
            transform: scale(1.01);
            transition: all 0.2s;
        }

        .correct {
            color: #28a745;
            font-weight: bold;
        }

        .wrong {
            color: #dc3545;
            font-weight: bold;
        }

        .win-rate-high {
            color: #28a745;
            font-weight: bold;
        }

        .win-rate-low {
            color: #dc3545;
            font-weight: bold;
        }

        /* 图表容器 */
        .chart-container {
            position: relative;
            height: 400px;
            min-height: 300px;
            width: 100%;
            background: white;
            border-radius: 8px;
            padding: 15px;
            box-sizing: border-box;
        }

        /* 响应式图表高度 */
        @media (max-width: 1400px) {
            .chart-container {
                height: 450px;
            }
        }

        @media (max-width: 768px) {
            .chart-container {
                height: 350px;
                padding: 10px;
            }
        }

        @media (max-width: 480px) {
            .chart-container {
                height: 300px;
                padding: 8px;
            }
        }

        /* 底部统计区 */
        .stats-section {
            padding: 20px 30px;
            background: #f8f9fa;
            border-top: 2px solid #e0e0e0;
        }

        .stats-item {
            font-size: 14px;
            font-weight: bold;
            margin: 8px 0;
            color: #333;
        }

        .stats-item.highlight {
            color: #b21824;
        }

        .stats-item.ai {
            color: #335397;
        }

        /* AI配置区 */
        .ai-config {
            display: flex;
            align-items: center;
            gap: 15px;
            margin: 15px 0;
            flex-wrap: wrap;
        }

        .ai-config label {
            font-size: 13px;
            font-weight: bold;
            color: #333;
        }

        .ai-config input {
            padding: 8px 12px;
            border: 2px solid #ddd;
            border-radius: 6px;
            font-size: 13px;
            min-width: 280px;
            transition: border-color 0.3s;
        }

        .ai-config input:focus {
            outline: none;
            border-color: #667eea;
        }

        .btn-ai {
            background: #16a085;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: bold;
            font-size: 13px;
            transition: all 0.3s;
        }

        .btn-ai:hover {
            background: #13856e;
            transform: scale(1.05);
        }

        .btn-contact {
            background: #e67e22;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: bold;
            font-size: 13px;
            margin-top: 15px;
            transition: all 0.3s;
        }

        .btn-contact:hover {
            background: #d35400;
            transform: scale(1.05);
        }

        /* 加载动画 */
        .loading {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-left: 8px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* 响应式设计 */
        @media (max-width: 1200px) {
            .main-content {
                padding: 15px;
            }

            .section {
                padding: 15px;
            }

            .table-container {
                max-height: 500px;
            }

            table {
                min-width: 900px;
                font-size: 11px;
            }

            th, td {
                padding: 8px 6px;
            }
        }

        @media (max-width: 768px) {
            body {
                padding: 10px;
            }

            .container {
                border-radius: 12px;
            }

            .header {
                padding: 15px 20px;
            }

            .header h1 {
                font-size: 20px;
            }

            .countdown-panel {
                padding: 20px 15px;
            }

            .big-timer {
                font-size: 48px;
                padding: 15px;
                min-width: 150px;
            }

            .predictions-row {
                flex-direction: column;
                gap: 10px;
            }

            .prediction-box {
                width: 100%;
                min-width: auto;
            }

            .info-bar {
                padding: 12px 15px;
                flex-direction: column;
                align-items: flex-start;
                gap: 10px;
            }

            .btn-refresh {
                margin-left: 0;
                width: 100%;
            }

            .main-content {
                padding: 10px;
                gap: 15px;
            }

            .section {
                padding: 12px;
            }

            .section-title {
                font-size: 16px;
            }

            .table-container {
                max-height: 400px;
                border-radius: 6px;
            }

            table {
                min-width: 800px;
                font-size: 10px;
            }

            th, td {
                padding: 6px 4px;
            }

            .stats-section {
                padding: 15px;
            }

            .stats-item {
                font-size: 12px;
            }

            .ai-config {
                flex-direction: column;
                align-items: stretch;
            }

            .ai-config input {
                width: 100%;
                min-width: auto;
            }

            .btn-ai, .btn-contact {
                width: 100%;
            }
        }

        @media (max-width: 480px) {
            .big-timer {
                font-size: 36px;
            }

            table {
                min-width: 700px;
                font-size: 9px;
            }

            th, td {
                padding: 5px 3px;
            }

            .chart-container {
                height: 250px;
            }
        }

        /* 滚动条样式 */
        .table-container::-webkit-scrollbar {
            width: 12px;
            height: 12px;
        }

        .table-container::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 6px;
            border: 1px solid #ddd;
        }

        .table-container::-webkit-scrollbar-thumb {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 6px;
            border: 2px solid #f1f1f1;
        }

        .table-container::-webkit-scrollbar-thumb:hover {
            background: linear-gradient(135deg, #5568d3 0%, #653a8a 100%);
        }

        .table-container::-webkit-scrollbar-corner {
            background: #f1f1f1;
        }

        /* Firefox滚动条样式 */
        .table-container {
            scrollbar-width: thin;
            scrollbar-color: #667eea #f1f1f1;
        }

        /* 错误提示框 */
        .error-alert {
            background: #fff3cd;
            border: 2px solid #ffc107;
            border-radius: 8px;
            padding: 15px 20px;
            margin: 15px 30px;
            color: #856404;
            font-size: 13px;
            line-height: 1.6;
            display: none;
            position: relative;
        }

        .error-alert.show {
            display: block;
        }

        .error-alert strong {
            color: #d00000;
            display: block;
            margin-bottom: 8px;
            font-size: 14px;
        }

        .error-alert ul {
            margin: 8px 0 0 20px;
        }

        .error-alert li {
            margin: 4px 0;
        }

        .error-alert code {
            background: #f8f9fa;
            padding: 2px 6px;
            border-radius: 3px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
        }

        .error-alert .close-btn {
            position: absolute;
            top: 10px;
            right: 10px;
            background: #ffc107;
            border: none;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            cursor: pointer;
            font-size: 16px;
            line-height: 1;
            color: #856404;
            font-weight: bold;
        }

        .error-alert .close-btn:hover {
            background: #ffb300;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>加拿大28 分析工具 2代 - PC28</h1>
            <p style="font-size: 14px; opacity: 0.9;">Q群：1077134386 | 飞机：@laomao12315</p>
        </div>

        <!-- CORS错误提示 -->
        <div class="error-alert" id="errorAlert">
            <button class="close-btn" onclick="hideErrorAlert()" title="关闭">×</button>
            <strong>⚠️ API访问失败（CORS限制）</strong>
            <div>解决方案：</div>
            <ul>
                <li><strong>方法1（推荐）：</strong>使用本地HTTP服务器运行此文件
                    <br>在文件所在目录打开命令行，运行：<code>python -m http.server 8000</code>
                    <br>然后访问：<code>http://localhost:8000/2代can2pros整合.html</code>
                </li>
                <li><strong>方法2：</strong>安装浏览器扩展（如"Allow CORS"或"CORS Unblock"）</li>
                <li><strong>方法3：</strong>使用Chrome启动参数（仅用于测试）
                    <br><code>chrome.exe --disable-web-security --user-data-dir="C:/temp/chrome_dev"</code>
                </li>
            </ul>
        </div>

        <!-- 倒计时面板 -->
        <div class="countdown-panel">
            <div class="big-timer" id="bigTimer">00:00</div>
            <div class="prev-summary" id="prevSummary">上一期：--</div>
            <div class="current-issue" id="currentIssue">本期期号：--</div>
            <div class="predictions-row">
                <div class="prediction-box prediction-laomao" id="laomaoPred">老猫预测：--</div>
                <div class="prediction-box prediction-kill2" id="kill2Pred">2号预测：--</div>
                <div class="prediction-box prediction-ai" id="aiPredTop">AI预测：--</div>
            </div>
            <div class="open-time" id="openTime">预计开奖时间：--</div>
        </div>

        <!-- 顶部信息区 -->
        <div class="info-bar">
            <div class="info-item" id="currentSection">当前期数：--</div>
            <div class="info-item" id="nextSection">下一期：--</div>
            <div class="info-item" id="remainingTime">本期剩余时间：--:--</div>
            <div class="info-item" id="serverDjs">服务器倒计时：-- 秒</div>
            <button class="btn-refresh" onclick="manualRefresh()">立即刷新</button>
        </div>

        <!-- 主要内容区 -->
        <div class="main-content">
            <!-- 历史记录表格 -->
            <div class="section">
                <div class="section-title">历史记录（最新 50 期）<span class="scroll-hint">← 左右滑动查看更多列 →</span></div>
                <div class="table-container">
                    <table id="historyTable">
                        <thead>
                            <tr>
                                <th>期号</th>
                                <th>时间</th>
                                <th>号码1</th>
                                <th>号码2</th>
                                <th>号码3</th>
                                <th>和值</th>
                                <th>大小单双</th>
                                <th>老猫预测对错</th>
                                <th>2号杀组对错</th>
                                <th>AI预测对错</th>
                                <th>老猫20期胜率</th>
                                <th>2号20期胜率</th>
                                <th>AI20期胜率</th>
                            </tr>
                        </thead>
                        <tbody id="tableBody">
                            <tr><td colspan="13" style="text-align: center; padding: 20px;">加载中...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- 走势图 -->
            <div class="section">
                <div class="section-title">走势图</div>
                <div class="chart-container">
                    <canvas id="trendChart"></canvas>
                </div>
            </div>
        </div>

        <!-- 底部统计区 -->
        <div class="stats-section">
            <div class="section-title">数据分析</div>
            <div class="stats-item" id="statsMain">最近 0 期统计：大 0  小 0  单 0  双 0</div>
            <div class="stats-item" id="streakInfo">连开情况：--</div>
            <div class="stats-item highlight" id="predictInfo">预测：--</div>
            
            <!-- AI配置 -->
            <div class="ai-config">
                <label>DeepSeek Token：</label>
                <input type="password" id="tokenInput" placeholder="在此输入 DeepSeek API Token">
                <button class="btn-ai" onclick="runAiPredict()">AI 预测当前期</button>
            </div>
            
            <div class="stats-item ai" id="aiPredict">AI 预测：--</div>
            <button class="btn-contact" onclick="showContact()">联系方式 / 免责声明</button>
        </div>
    </div>

    <script>
        // 全局变量
        const BASE_URL = "https://pc28yb.com/";
        let latestRecords = [];
        let aiPredictionsByIssue = {};
        let currentSection = "";
        let nextSection = "";
        let remainingSeconds = 0;
        let serverDjsSeconds = 0;
        let trendChart = null;
        const PERIOD_SECONDS = 210;

        // 初始化
        document.addEventListener('DOMContentLoaded', function() {
            // 加载保存的Token
            loadDeepSeekToken();
            
            // 初始化图表
            initChart();
            
            // 首次加载数据
            autoRefreshFromServer();
            
            // 启动定时器
            setInterval(onTimerTick, 1000);
            
            // 窗口大小改变时重新调整图表
            let resizeTimer;
            window.addEventListener('resize', function() {
                clearTimeout(resizeTimer);
                resizeTimer = setTimeout(function() {
                    if (trendChart) {
                        trendChart.resize();
                    }
                }, 250);
            });
        });

        // 工具函数
        function formatTime(seconds) {
            const m = Math.max(0, Math.floor(seconds / 60));
            const s = Math.max(0, seconds % 60);
            return `${String(m).padStart(2, '0')}:${String(s).padStart(2, '0')}`;
        }

        // CORS代理配置 - 使用多个代理服务作为备选
        const CORS_PROXIES = [
            'https://api.allorigins.win/raw?url=',
            'https://corsproxy.io/?',
            'https://api.codetabs.com/v1/proxy?quest='
        ];
        let currentProxyIndex = 0;
        
        // API调用（自动尝试多个CORS代理）
        async function apiGet(path, params = {}, asJson = false) {
            const url = new URL(path, BASE_URL);
            Object.keys(params).forEach(key => url.searchParams.append(key, params[key]));
            const targetUrl = url.toString();
            
            // 首先尝试直接访问
            try {
                const response = await fetch(targetUrl, {
                    method: 'GET',
                    mode: 'cors',
                    cache: 'no-cache',
                    headers: {
                        'Accept': asJson ? 'application/json' : 'text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8'
                    }
                });
                
                if (response.ok) {
                    return asJson ? await response.json() : await response.text();
                }
            } catch (directError) {
                console.log('直接访问失败，尝试使用CORS代理...', directError.message);
            }
            
            // 如果直接访问失败，尝试使用CORS代理
            let lastError = null;
            for (let i = 0; i < CORS_PROXIES.length; i++) {
                const proxyIndex = (currentProxyIndex + i) % CORS_PROXIES.length;
                const proxyUrl = CORS_PROXIES[proxyIndex] + encodeURIComponent(targetUrl);
                
                try {
                    const response = await fetch(proxyUrl, {
                        method: 'GET',
                        mode: 'cors',
                        cache: 'no-cache'
                    });
                    
                    if (response.ok) {
                        currentProxyIndex = proxyIndex; // 记住成功的代理
                        const result = await response.text();
                        
                        // 如果是JSON，尝试解析
                        if (asJson) {
                            try {
                                return JSON.parse(result);
                            } catch (e) {
                                // 如果解析失败，可能代理返回了包装的JSON
                                const jsonMatch = result.match(/\{[\s\S]*\}/);
                                if (jsonMatch) {
                                    return JSON.parse(jsonMatch[0]);
                                }
                                throw new Error('无法解析JSON响应');
                            }
                        }
                        return result;
                    }
                } catch (proxyError) {
                    console.log(`代理 ${proxyIndex + 1} 失败:`, proxyError.message);
                    lastError = proxyError;
                    continue;
                }
            }
            
            // 所有方法都失败
            const errorMsg = 'API访问失败：CORS限制。解决方案：\n' +
                '1. 安装浏览器扩展（如CORS Unblock）\n' +
                '2. 使用本地HTTP服务器运行（如：python -m http.server）\n' +
                '3. 使用Chrome启动参数：--disable-web-security --user-data-dir="C:/temp/chrome_dev"';
            throw new Error(errorMsg);
        }

        async function getNextInfo() {
            return await apiGet("index.php", {gameType: "jnd28", action: "next"}, true);
        }

        async function getGuessJson() {
            const text = await apiGet("index.php", {action: "getMyOpensJson"});
            return JSON.parse(text);
        }

        async function getShazuPredictions() {
            const predictions = {};
            try {
                const targetUrl = "http://www.xyyc28.top/jnd/jndsz.php";
                let html = '';
                
                // 尝试直接访问
                try {
                    const response = await fetch(targetUrl, {
                        method: 'GET',
                        mode: 'cors',
                        cache: 'no-cache'
                    });
                    if (response.ok) {
                        html = await response.text();
                    } else {
                        throw new Error('Direct fetch failed');
                    }
                } catch (directError) {
                    // 使用CORS代理
                    const proxyUrl = CORS_PROXIES[currentProxyIndex] + encodeURIComponent(targetUrl);
                    const response = await fetch(proxyUrl, {
                        method: 'GET',
                        mode: 'cors',
                        cache: 'no-cache'
                    });
                    if (response.ok) {
                        html = await response.text();
                    } else {
                        throw new Error('Proxy fetch failed');
                    }
                }
                
                // 简单的HTML解析（如果需要更复杂可以用DOMParser）
                const parser = new DOMParser();
                const doc = parser.parseFromString(html, 'text/html');
                const tbody = doc.querySelector('tbody#biaoge') || doc.querySelector('tbody');
                
                if (tbody) {
                    const rows = tbody.querySelectorAll('tr');
                    rows.forEach(tr => {
                        const tds = tr.querySelectorAll('td');
                        if (tds.length >= 5) {
                            const section = tds[0].textContent.trim();
                            const predTd = tds[3];
                            const fonts = predTd.querySelectorAll('font');
                            let predDisplay = "";
                            if (fonts.length >= 2) {
                                predDisplay = `${fonts[0].textContent.trim()} + ${fonts[1].textContent.trim()}`;
                            } else {
                                predDisplay = predTd.textContent.trim();
                            }
                            
                            const resultTd = tds[4];
                            const resultText = resultTd.textContent.trim();
                            let result = "";
                            if (resultText.includes("正确")) {
                                result = "对";
                            } else if (resultText.includes("错误")) {
                                result = "错";
                            }
                            
                            predictions[section] = [predDisplay, result];
                        }
                    });
                }
            } catch (error) {
                console.error('获取2号预测失败:', error);
            }
            return predictions;
        }

        // 数据类
        class OpenRecord {
            constructor(section, openCodes, openTime) {
                this.section = section;
                this.openCodes = openCodes;
                this.openTime = openTime;
            }

            get total() {
                return this.openCodes.slice(0, 3).reduce((a, b) => a + b, 0);
            }

            get da_xiao() {
                return this.total >= 14 ? "大" : "小";
            }

            get dan_shuang() {
                return this.total % 2 === 1 ? "单" : "双";
            }
        }

        // 预测格式化
        function formatPredictionDisplay(prediction) {
            if (!prediction || prediction === "未知" || prediction === "获取中...") {
                return prediction;
            }
            
            if (prediction.includes("+")) {
                const parts = prediction.split("+");
                if (parts.length === 2) {
                    const part1 = parts[0].trim();
                    const part2 = parts[1].trim();
                    
                    if (part2.length === 2 && ["大", "小"].includes(part2[0]) && ["单", "双"].includes(part2[1])) {
                        const dx2 = part2[0];
                        const ds2 = part2[1];
                        let resultList = [];
                        
                        if (part1 === "大") {
                            resultList = ["大单", "大双"];
                        } else if (part1 === "小") {
                            resultList = ["小双", "小单"];
                        } else if (part1 === "单") {
                            resultList = ["大单", "小单"];
                        } else if (part1 === "双") {
                            resultList = ["大双", "小双"];
                        }
                        
                        if (!resultList.includes(part2)) {
                            resultList.push(part2);
                        }
                        
                        return resultList.join("");
                    }
                }
                return prediction;
            }
            
            const mapping = {
                "大单": "大单大双小单",
                "大双": "大单大双小双",
                "小单": "大单小单小双",
                "小双": "大双小单小双"
            };
            
            return mapping[prediction] || prediction;
        }

        // 计算胜率
        function calculateWinRate(records, predictResultBySection, shazuPredictions, aiPredictions, modelType, startIndex, periodCount = 20) {
            if (startIndex >= records.length) return "--";
            
            const endIndex = Math.min(records.length, startIndex + periodCount);
            const targetRecords = records.slice(startIndex, endIndex);
            
            if (targetRecords.length === 0) return "--";
            
            let correctCount = 0;
            let totalCount = 0;
            
            for (const r of targetRecords) {
                if (modelType === "laomao") {
                    const hit = predictResultBySection[r.section];
                    if (hit) {
                        totalCount++;
                        if (hit === "对") correctCount++;
                    }
                } else if (modelType === "kill2") {
                    if (r.section in shazuPredictions) {
                        const [, kill2Hit] = shazuPredictions[r.section];
                        if (kill2Hit) {
                            totalCount++;
                            if (kill2Hit === "对") correctCount++;
                        }
                    }
                } else if (modelType === "ai") {
                    const aiCombo = aiPredictions[r.section];
                    if (aiCombo) {
                        const aiDx = aiCombo[0] && ["大", "小"].includes(aiCombo[0]) ? aiCombo[0] : "";
                        const aiDs = aiCombo.length > 1 && ["单", "双"].includes(aiCombo[1]) ? aiCombo[1] : "";
                        if (aiDx || aiDs) {
                            totalCount++;
                            const correct = (aiDx === r.da_xiao) || (aiDs === r.dan_shuang);
                            if (correct) correctCount++;
                        }
                    }
                }
            }
            
            if (totalCount === 0) return "--";
            
            const winRate = (correctCount / totalCount) * 100;
            return `${winRate.toFixed(1)}%`;
        }

        // 自动刷新
        async function autoRefreshFromServer() {
            try {
                // 隐藏之前的错误提示
                hideErrorAlert();
                
                const nextInfo = await getNextInfo();
                const nextSec = String(nextInfo.section || "");
                const djs = parseInt(nextInfo.djs || PERIOD_SECONDS);
                
                let cur = "--";
                try {
                    cur = String(parseInt(nextSec) - 1);
                } catch (e) {}
                
                currentSection = cur;
                nextSection = nextSec;
                remainingSeconds = djs;
                serverDjsSeconds = djs;
                
                document.getElementById('currentSection').textContent = `当前期数：${cur}`;
                document.getElementById('nextSection').textContent = `下一期：${nextSec}`;
                document.getElementById('currentIssue').textContent = `本期期号：${nextSec}`;
                
                const eta = new Date(Date.now() + djs * 1000);
                document.getElementById('openTime').textContent = 
                    `预计开奖时间：${eta.toLocaleString('zh-CN', {year: 'numeric', month: '2-digit', day: '2-digit', hour: '2-digit', minute: '2-digit', second: '2-digit'})}`;
                
                document.getElementById('serverDjs').textContent = `服务器倒计时：${djs} 秒`;
                updateRemainingLabel();
                
                await loadHistoryAndStatistics();
                
                // 如果已配置Token，自动进行AI预测
                const token = localStorage.getItem('deepseek_token');
                if (token) {
                    runAiPredict(true);
                }
            } catch (error) {
                console.error('获取下一期信息失败:', error);
                // 显示错误提示框
                const errorAlert = document.getElementById('errorAlert');
                if (errorAlert) {
                    errorAlert.classList.add('show');
                }
                // 也显示alert以便用户立即看到
                if (error.message.includes('CORS') || error.message.includes('Failed to fetch')) {
                    // CORS错误已经在提示框中说明了，不需要重复alert
                } else {
                    alert(`获取下一期信息失败：\n${error.message}`);
                }
            }
        }
        
        // 隐藏错误提示框
        function hideErrorAlert() {
            const errorAlert = document.getElementById('errorAlert');
            if (errorAlert) {
                errorAlert.classList.remove('show');
            }
        }

        async function loadHistoryAndStatistics() {
            try {
                const raw = await getGuessJson();
                const data = raw.data || [];
                const records = [];
                
                for (const item of data.slice(0, 50)) {
                    const codes = [];
                    for (let i = 1; i <= 10; i++) {
                        const key = `openCode${i}`;
                        try {
                            codes.push(parseInt(item[key] || "0"));
                        } catch (e) {
                            codes.push(0);
                        }
                    }
                    records.push(new OpenRecord(
                        String(item.section || ""),
                        codes,
                        String(item.openTime || "")
                    ));
                }
                
                latestRecords = records;
                
                // 计算老猫预测对错
                const orderedOldToNew = [...records].sort((a, b) => a.openTime.localeCompare(b.openTime));
                const predictResultBySection = {};
                
                for (let i = 0; i < orderedOldToNew.length - 1; i++) {
                    const base = orderedOldToNew[i];
                    const target = orderedOldToNew[i + 1];
                    
                    if (base.openCodes.length < 3 || target.openCodes.length < 3) continue;
                    
                    const n1 = base.openCodes[0];
                    const n2 = base.openCodes[1];
                    const n3 = base.openCodes[2];
                    const guessDx = (n2 + n3) > 13 ? "大" : "小";
                    const guessDs = (n1 + n2) % 2 === 1 ? "单" : "双";
                    
                    const correct = (guessDx === target.da_xiao) || (guessDs === target.dan_shuang);
                    predictResultBySection[target.section] = correct ? "对" : "错";
                }
                
                // 按时间倒序
                const sortedByTime = [...records].sort((a, b) => b.openTime.localeCompare(a.openTime));
                
                // 更新上一期信息
                if (sortedByTime.length > 0) {
                    const last = sortedByTime[0];
                    const combo = `${last.da_xiao}${last.dan_shuang}`;
                    const numsHtml = last.openCodes.slice(0, 3).map(n => 
                        `<span class="number-badge">${n}</span>`
                    ).join("");
                    document.getElementById('prevSummary').innerHTML = 
                        `上一期：${last.section}  ${numsHtml}  <span style="color:#d00000;font-weight:bold;">${combo}</span>`;
                    
                    updatePrediction(last);
                }
                
                // 获取2号预测
                const shazuPredictions = await getShazuPredictions();
                
                // 更新表格
                populateTable(sortedByTime, predictResultBySection, shazuPredictions);
                
                // 更新走势图
                updateTrendChart(records.slice(0, 30));
                
                // 更新统计
                updateStatistics(records);
            } catch (error) {
                console.error('获取历史数据失败:', error);
                alert(`获取历史数据失败：\n${error.message}`);
            }
        }

        function populateTable(records, predictResultBySection, shazuPredictions = {}) {
            const tbody = document.getElementById('tableBody');
            tbody.innerHTML = "";
            
            for (let row = 0; row < records.length; row++) {
                const r = records[row];
                const combo = `${r.da_xiao}${r.dan_shuang}`;
                const hit = predictResultBySection[r.section] || "";
                
                let kill2Hit = "";
                if (r.section in shazuPredictions) {
                    [, kill2Hit] = shazuPredictions[r.section];
                }
                
                let aiHit = "";
                const aiCombo = aiPredictionsByIssue[r.section];
                if (aiCombo) {
                    const aiDx = aiCombo[0] && ["大", "小"].includes(aiCombo[0]) ? aiCombo[0] : "";
                    const aiDs = aiCombo.length > 1 && ["单", "双"].includes(aiCombo[1]) ? aiCombo[1] : "";
                    if (aiDx || aiDs) {
                        const correct = (aiDx === r.da_xiao) || (aiDs === r.dan_shuang);
                        aiHit = correct ? "对" : "错";
                    }
                }
                
                const laomaoRate = calculateWinRate(records, predictResultBySection, shazuPredictions, aiPredictionsByIssue, "laomao", row, 20);
                const kill2Rate = calculateWinRate(records, predictResultBySection, shazuPredictions, aiPredictionsByIssue, "kill2", row, 20);
                const aiRate = calculateWinRate(records, predictResultBySection, shazuPredictions, aiPredictionsByIssue, "ai", row, 20);
                
                const tr = document.createElement('tr');
                const values = [
                    r.section,
                    r.openTime,
                    String(r.openCodes[0]),
                    String(r.openCodes[1]),
                    String(r.openCodes[2]),
                    String(r.total),
                    combo,
                    hit,
                    kill2Hit,
                    aiHit,
                    laomaoRate,
                    kill2Rate,
                    aiRate
                ];
                
                values.forEach((v, col) => {
                    const td = document.createElement('td');
                    td.textContent = v;
                    
                    if (col === 7 || col === 8 || col === 9) {
                        if (v === "对") {
                            td.className = "correct";
                        } else if (v === "错") {
                            td.className = "wrong";
                        }
                    } else if (col === 10 || col === 11 || col === 12) {
                        if (v !== "--") {
                            try {
                                const rateValue = parseFloat(v.replace("%", ""));
                                if (rateValue >= 50) {
                                    td.className = "win-rate-high";
                                } else {
                                    td.className = "win-rate-low";
                                }
                            } catch (e) {}
                        }
                    }
                    
                    tr.appendChild(td);
                });
                
                tbody.appendChild(tr);
            }
        }

        function updateStatistics(records) {
            if (records.length === 0) {
                document.getElementById('statsMain').textContent = "最近 0 期统计：大 0  小 0  单 0  双 0";
                document.getElementById('streakInfo').textContent = "连开情况：--";
                return;
            }
            
            let stats = {大: 0, 小: 0, 单: 0, 双: 0};
            records.forEach(r => {
                stats[r.da_xiao]++;
                stats[r.dan_shuang]++;
            });
            
            document.getElementById('statsMain').textContent = 
                `最近 ${records.length} 期统计：大 ${stats.大}  小 ${stats.小}  单 ${stats.单}  双 ${stats.双}`;
            
            const last = records[0];
            const lastDx = last.da_xiao;
            const lastDs = last.dan_shuang;
            
            let streakDx = 0;
            let streakDs = 0;
            
            for (const r of records) {
                if (r.da_xiao === lastDx) {
                    streakDx++;
                } else {
                    break;
                }
            }
            
            for (const r of records) {
                if (r.dan_shuang === lastDs) {
                    streakDs++;
                } else {
                    break;
                }
            }
            
            document.getElementById('streakInfo').textContent = 
                `连开情况：最近 ${streakDx} 期都是「${lastDx}」，最近 ${streakDs} 期都是「${lastDs}」`;
        }

        function updatePrediction(last) {
            if (last.openCodes.length < 3) {
                document.getElementById('predictInfo').textContent = "预测：数据不足";
                document.getElementById('laomaoPred').textContent = "老猫预测：数据不足";
                document.getElementById('kill2Pred').textContent = "2号预测：数据不足";
                return;
            }
            
            const n1 = last.openCodes[0];
            const n2 = last.openCodes[1];
            const n3 = last.openCodes[2];
            
            const guessDx = (n2 + n3) > 13 ? "大" : "小";
            const guessDs = (n1 + n2) % 2 === 1 ? "单" : "双";
            
            const combo = guessDx + guessDs;
            const killCombo = (guessDx === "大" ? "小" : "大") + (guessDs === "单" ? "双" : "单");
            
            let nextSec = "未知";
            try {
                nextSec = String(parseInt(last.section) + 1);
            } catch (e) {}
            
            // 获取2号预测
            getShazuPredictions().then(shazuPredictions => {
                let killDisplay2 = "获取中...";
                if (nextSec in shazuPredictions) {
                    [killDisplay2] = shazuPredictions[nextSec];
                }
                
                document.getElementById('predictInfo').textContent = 
                    `预测下一期（${nextSec}）：组合 ${combo}，杀组 ${killCombo}，大小 ${guessDx}，单双 ${guessDs}    |    2号预测：${killDisplay2}`;
                
                const laomaoDisplay = formatPredictionDisplay(combo);
                document.getElementById('laomaoPred').textContent = `老猫预测：${laomaoDisplay}`;
                
                const kill2Display = formatPredictionDisplay(killDisplay2);
                document.getElementById('kill2Pred').textContent = `2号预测：${kill2Display}`;
            });
        }

        // 图表初始化
        function initChart() {
            const ctx = document.getElementById('trendChart').getContext('2d');
            trendChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: '和值',
                        data: [],
                        borderColor: '#0078d4',
                        backgroundColor: 'rgba(0, 120, 212, 0.1)',
                        borderWidth: 2,
                        pointRadius: 4,
                        pointBackgroundColor: '#0078d4',
                        tension: 0.1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    resizeDelay: 0,
                    plugins: {
                        title: {
                            display: true,
                            text: '和值走势',
                            font: {
                                size: 16,
                                weight: 'bold'
                            }
                        },
                        legend: {
                            display: false
                        },
                        tooltip: {
                            enabled: true,
                            mode: 'index',
                            intersect: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: false,
                            min: -1,
                            max: 28,
                            title: {
                                display: true,
                                text: '和值',
                                font: {
                                    size: 12
                                }
                            },
                            ticks: {
                                font: {
                                    size: 11
                                }
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: '期数（从旧到新）',
                                font: {
                                    size: 12
                                }
                            },
                            ticks: {
                                font: {
                                    size: 11
                                },
                                maxRotation: 45,
                                minRotation: 0
                            }
                        }
                    },
                    interaction: {
                        intersect: false,
                        mode: 'index'
                    }
                }
            });
        }

        function updateTrendChart(records) {
            if (!trendChart || records.length === 0) return;
            
            const ordered = [...records].reverse();
            const totals = ordered.map(r => r.total);
            const labels = ordered.map((r, i) => i + 1);
            
            trendChart.data.labels = labels;
            trendChart.data.datasets[0].data = totals;
            trendChart.update();
        }

        // 定时器
        function updateRemainingLabel() {
            const text = formatTime(remainingSeconds);
            document.getElementById('remainingTime').textContent = `本期剩余时间：${text}`;
            document.getElementById('bigTimer').textContent = text;
        }

        function onTimerTick() {
            if (remainingSeconds > 0) {
                remainingSeconds--;
            }
            updateRemainingLabel();
            
            if (serverDjsSeconds > 0) {
                serverDjsSeconds--;
            }
            document.getElementById('serverDjs').textContent = `服务器倒计时：${Math.max(serverDjsSeconds, 0)} 秒`;
            
            if (remainingSeconds <= 0) {
                autoRefreshFromServer();
            }
        }

        // 手动刷新
        function manualRefresh() {
            autoRefreshFromServer();
        }

        // AI预测
        async function runAiPredict(auto = false) {
            const tokenInput = document.getElementById('tokenInput');
            const token = tokenInput.value.trim();
            
            if (!token) {
                if (!auto) {
                    alert("请先在下方输入 DeepSeek API Token。");
                }
                return;
            }
            
            // 保存Token
            localStorage.setItem('deepseek_token', token);
            
            if (!latestRecords.length || !nextSection) {
                if (!auto) {
                    alert("暂无历史数据，无法进行 AI 预测。");
                }
                return;
            }
            
            const N = 20;
            const ordered = [...latestRecords].sort((a, b) => b.openTime.localeCompare(a.openTime));
            const contextRecords = ordered.slice(0, N);
            
            const historyLines = contextRecords.map(r => 
                `期号 ${r.section} 和值 ${r.total} 大小 ${r.da_xiao} 单双 ${r.dan_shuang}`
            );
            const historyText = historyLines.join("\n");
            
            const prompt = `你是一个只做数据统计和模式分析的助手，专门分析加拿大28（PC28）历史开奖结果的走势，根据最近的历史数据，预测**下一期**的大小单双。

注意：下面的历史数据**第一行是最新一期**，往下越旧，只看这些数据来做判断。
历史数据格式：期号 和值 大小 单双。
以下是最近的历史数据（从新到旧）：
${historyText}

现在要预测的期号是：${nextSection}。
请只基于上面这些最近数据给出一个客观的推测结果，并且严格只输出以下 4 个结果之一：大单、大双、小单、小双。
不要输出其他任何文字。`;
            
            try {
                const response = await fetch("https://api.deepseek.com/v1/chat/completions", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                        "Authorization": `Bearer ${token}`
                    },
                    body: JSON.stringify({
                        model: "deepseek-chat",
                        messages: [
                            {role: "system", content: "你是一个加拿大28走势分析助手。"},
                            {role: "user", content: prompt}
                        ],
                        temperature: 0.6,
                        max_tokens: 16
                    })
                });
                
                if (!response.ok) throw new Error(`HTTP ${response.status}`);
                
                const data = await response.json();
                let aiText = data.choices?.[0]?.message?.content?.trim() || "";
                
                for (const kw of ["大单", "大双", "小单", "小双"]) {
                    if (aiText.includes(kw)) {
                        aiText = kw;
                        break;
                    }
                }
                
                if (["大单", "大双", "小单", "小双"].includes(aiText)) {
                    aiPredictionsByIssue[nextSection] = aiText;
                }
                
                document.getElementById('aiPredict').textContent = 
                    `AI 预测（${nextSection}）：${aiText || '获取失败'}`;
                
                if (["大单", "大双", "小单", "小双"].includes(aiText)) {
                    const aiDisplay = formatPredictionDisplay(aiText);
                    document.getElementById('aiPredTop').textContent = `AI预测：${aiDisplay}`;
                } else {
                    document.getElementById('aiPredTop').textContent = `AI预测：${aiText || '获取失败'}`;
                }
            } catch (error) {
                console.error('AI预测失败:', error);
                if (!auto) {
                    alert(`调用 DeepSeek 接口出错：\n${error.message}`);
                }
                document.getElementById('aiPredTop').textContent = "AI预测：获取失败";
            }
        }

        // Token管理
        function loadDeepSeekToken() {
            const token = localStorage.getItem('deepseek_token');
            if (token) {
                document.getElementById('tokenInput').value = token;
            }
        }

        // 联系方式
        function showContact() {
            alert("【联系方式】\nQ群：1077134386\nTelegram（飞机）：@laomao12315\n\n【免责声明】\n本工具仅用于数据展示和走势分析，不提供任何形式的投注建议或保证盈利。\n彩票、游戏等具有高风险，请理性参与，自负盈亏。");
        }
    </script>
</body>
</html>
